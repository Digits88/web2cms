{{extend 'layout.html'}}

<!-- LIST OF NODES -->
{{for node in nodes:}}
{{=XML(response.render('content/node-article.html', dict(node=node, teaser=True)))}}
{{pass}}

<!-- PAGER -->
{{
def url_to_page(page_id):
    _vars = request.vars.copy()
    _vars['page'] = page_id
    return URL(
        request.application,
        request.controller,
        request.function,
        args=request.args,
        vars=_vars,
    )
    pass
}}
{{if nodes_count > articles_per_page:}}
{{
import math
pages_count = int(math.ceil(1.0 * nodes_count / articles_per_page))
}}
<div class="pager-container">
<ul class="pager">
    {{if page_id > 0:}}
    <li>{{=A(T('first'), _href=url_to_page(0))}}</li>
    <li>{{=A(T('previous'), _href=url_to_page(page_id-1))}}</li>
    {{pass}}
    {{for i in range(pages_count):}}
    <li>{{=A("%d" % (i+1), _href=url_to_page(i), _class=('current' if i == page_id else '') )}}</li>
    {{pass}}
    {{if page_id < (pages_count-1):}}
    <li>{{=A(T('next'), _href=url_to_page(page_id+1))}}</li>
    <li>{{=A(T('last'), _href=url_to_page(pages_count-1))}}</li>
    {{pass}}
</ul>
</div>
{{pass}}


<!-- DEBUG -->
<!-- nodes_count={{=nodes_count}}<br/>
page_id={{=page_id}}<br/>
articles_per_page={{=articles_per_page}}<br/> -->

{{if False:}}
<!-- TEST - AJAX LOADING OF PAGES -->
<!-- <script>
function dynamic_load(load_path) {
    alert('Will load dynamically! ' + load_path);
    new_content = $.get(
        "{{=URL('default', 'get_page_content.json')}}",
        {"path" : load_path},
        function (data, textStatus, jqXHR) {
            alert("Received data:\n\n" + data.content);
            $('#content-region-content').html(data.content);
            w2cms_update_links();
        }, 'json')
}

function w2cms_update_links() {
	// Mark as "ajax-ready"!
    $('.pager > li > a').css('color', '#f00');
    
    // Convert to fragment links
    $('.pager > li > a').each(function(){
    	if (this._rel_load_url) return;
        _url = $(this).url();
        _rel_load_url = _url.attr('path') + '?' + _url.attr('query');
        this.href='#!' + _rel_load_url;
        this._rel_load_url = _rel_load_url;
        $(this).click(function(){
            dynamic_load(this._rel_load_url);
        });
    });
}

$(document).load(function(){alert('load');});
$(document).ready(function(){
    w2cms_update_links();
    
    // Load page if needed
    _url = $(this).url();
    fragment = _url.attr('fragment')
    if (fragment.match(/^!/)) {
        load_path = fragment.replace(/^!/, '')
        dynamic_load(load_path);
    }
});
</script>
 -->
{{pass}}
